{"version":3,"sources":["../../../../../../apps/krafta/lib/catalogs/data.ts","../../../../../../apps/krafta/lib/supabase/server.ts","../../../../../../node_modules/.pnpm/next%4016.1.2_%40babel%2Bcore%407.28.5_react-dom%4019.2.3_react%4019.2.3__react%4019.2.3/node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../../../apps/krafta/.next-internal/server/app/dashboard/%5BorgSlug%5D/%5BcatalogSlug%5D/builder/page/actions.js%20%28server%20actions%20loader%29","../../../../../../apps/krafta/lib/catalogs/revalidate.ts","../../../../../../apps/krafta/app/dashboard/%5BorgSlug%5D/%5BcatalogSlug%5D/builder/actions.ts"],"sourcesContent":["// lib/catalogs/data.ts\nimport { cacheTag } from \"next/cache\";\nimport type { Catalog, CategoryWithItems, Item, CatalogCategory } from \"./types\";\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\nif (!supabaseUrl || !supabaseAnonKey) {\n  throw new Error(\"Missing Supabase environment variables.\");\n}\n\nconst supabaseHeaders = {\n  apikey: supabaseAnonKey,\n  Authorization: `Bearer ${supabaseAnonKey}`,\n};\n\nexport async function getCatalogBySlug(\n  slug: string\n): Promise<Catalog | null> {\n  \"use cache\";\n  cacheTag(`catalog:${slug}`, \"catalogs\");\n\n  const url = `${supabaseUrl}/rest/v1/catalogs?slug=eq.${encodeURIComponent(\n    slug,\n  )}&select=*`;\n  const response = await fetch(url, {\n    headers: supabaseHeaders,\n    next: {\n      tags: [`catalog:${slug}`, \"catalogs\"],\n    },\n    cache: \"force-cache\",\n  });\n\n  if (!response.ok) return null;\n  const data = (await response.json()) as Catalog[];\n  const catalog = data[0] ?? null;\n  if (catalog?.id) {\n    cacheTag(`catalog:${catalog.id}`);\n  }\n  return catalog;\n}\n\nexport async function getCatalogStructure(\n  catalogId: string\n): Promise<CategoryWithItems[]> {\n  \"use cache\";\n  cacheTag(`catalog:${catalogId}`, `catalog-structure:${catalogId}`);\n\n  const categoriesUrl = `${supabaseUrl}/rest/v1/catalog_categories?catalog_id=eq.${encodeURIComponent(\n    catalogId,\n  )}&is_active=eq.true&select=*&order=position.asc`;\n  const itemsUrl = `${supabaseUrl}/rest/v1/items?catalog_id=eq.${encodeURIComponent(\n    catalogId,\n  )}&is_active=eq.true&select=*&order=position.asc`;\n\n  const [categoriesResponse, itemsResponse] = await Promise.all([\n    fetch(categoriesUrl, {\n      headers: supabaseHeaders,\n      next: {\n        tags: [`catalog:${catalogId}`, `catalog-structure:${catalogId}`],\n      },\n      cache: \"force-cache\",\n    }),\n    fetch(itemsUrl, {\n      headers: supabaseHeaders,\n      next: {\n        tags: [`catalog:${catalogId}`, `catalog-structure:${catalogId}`],\n      },\n      cache: \"force-cache\",\n    }),\n  ]);\n\n  if (!categoriesResponse.ok) return [];\n  const categories = (await categoriesResponse.json()) as CatalogCategory[];\n\n  if (!itemsResponse.ok) {\n    return categories.map((category) => ({\n      ...category,\n      items: [],\n    }));\n  }\n  const items = (await itemsResponse.json()) as Item[];\n\n  const itemsByCategory = new Map<string, Item[]>();\n  for (const item of items) {\n    const list = itemsByCategory.get(item.category_id) ?? [];\n    list.push(item);\n    itemsByCategory.set(item.category_id, list);\n  }\n\n  return categories.map((category) => ({\n    ...category,\n    items: itemsByCategory.get(category.id) ?? [],\n  }));\n}\n","import { createServerClient } from \"@supabase/ssr\";\nimport type { Database } from \"@/lib/supabase/types\";\nimport { cookies } from \"next/headers\";\n\n/**\n * Especially important if using Fluid compute: Don't put this client in a\n * global variable. Always create a new client within each function when using\n * it.\n */\nexport async function createClient() {\n  const cookieStore = await cookies();\n\n  return createServerClient<Database>(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll() {\n          return cookieStore.getAll();\n        },\n        setAll(cookiesToSet) {\n          try {\n            cookiesToSet.forEach(({ name, value, options }) =>\n              cookieStore.set(name, value, options),\n            );\n          } catch {\n            // The `setAll` method was called from a Server Component.\n            // This can be ignored if you have middleware refreshing\n            // user sessions.\n          }\n        },\n      },\n    },\n  );\n}","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","export {$$RSC_SERVER_CACHE_0 as 'e002568b17f807f12d4e53a46203b4c7c130a15e5e'} from 'ACTIONS_MODULE0'\nexport {saveCatalogLayout as '40f004e0f0cb0bd60f0648085f8ad2f288c4e6b215'} from 'ACTIONS_MODULE1'\nexport {$$RSC_SERVER_CACHE_0 as 'c0611dc6a5681bb4412dfda78e34745b9a6ae84010'} from 'ACTIONS_MODULE2'\nexport {$$RSC_SERVER_CACHE_1 as 'c09c6fb5a83fb2f73507c066d40fb710f559db9b35'} from 'ACTIONS_MODULE2'\n","\"use server\";\n\nimport { revalidateTag, updateTag } from \"next/cache\";\n\nexport async function updateCatalogByIdAndSlug(params: {\n  catalogId: string;\n  catalogSlug?: string;\n}) {\n  updateTag(`catalog:${params.catalogId}`);\n  updateTag(`catalog-structure:${params.catalogId}`);\n  updateTag(\"catalogs\");\n  if (params.catalogSlug) {\n    updateTag(`catalog:${params.catalogSlug}`);\n  }\n}\n\nexport async function revalidateCatalogById(catalogId: string) {\n  revalidateTag(`catalog:${catalogId}`, \"max\");\n  revalidateTag(`catalog-structure:${catalogId}`, \"max\");\n}\n\nexport async function revalidateCatalogBySlug(slug: string) {\n  revalidateTag(`catalog:${slug}`, \"max\");\n}\n","\"use server\";\n\nimport { updateCatalogByIdAndSlug } from \"@/lib/catalogs/revalidate\";\nimport { createClient } from \"@/lib/supabase/server\";\nimport type { CatalogLayoutSettings } from \"@/lib/catalogs/settings/layout\";\nimport type { CurrencySettings } from \"@/lib/catalogs/settings/currency\";\n\nexport async function saveCatalogLayout(params: {\n  catalogId: string;\n  catalogSlug: string;\n  settingsLayout: CatalogLayoutSettings;\n  settingsCurrency: CurrencySettings;\n}) {\n  const supabase = await createClient();\n\n  const { error } = await supabase\n    .from(\"catalogs\")\n    .update({\n      settings_layout: params.settingsLayout,\n      settings_currency: params.settingsCurrency,\n    })\n    .eq(\"id\", params.catalogId);\n\n  if (error) {\n    return { ok: false, error: error.message };\n  }\n\n  await updateCatalogByIdAndSlug({\n    catalogId: params.catalogId,\n    catalogSlug: params.catalogSlug,\n  });\n\n  return { ok: true };\n}\n"],"names":["ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"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","ignoreList":[2]}